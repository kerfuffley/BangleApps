<html>
  <head>
    <link rel="stylesheet" href="../../css/spectre.min.css">
  </head>
  <body>
    <h3>1. Get a Fitbit account if you don't have one already</h3>
    <p>Do this at <a href="https://accounts.fitbit.com/signup">accounts.fitbit.com/signup</a>. After signing up you'll also need to verify your email.</p>
    <h3>2. Register an app</h3>
    <p>You need to do this in order to use Fitbit's API. Follow <a href="https://dev.fitbit.com/build/reference/web-api/developer-guide/getting-started/#Registering-an-Application">these instructions</a> to register an app. <strong>Have your app's settings match the following:</strong>:</p>
    <ul>
      <li>OAuth 2.0 Application Type: Personal</li>
      <li>Redirect URL: <code>http://localhost</code></li>
      <li>Default Access Type: Read & Write</li>
    </ul>
    <p>The other settings don't matter as far as this Bangle.js app is concerned, so change them to whatever you want.</p>
    <h3>3. Allow access and get other app info</h3>
    <ol>
      <li>Enter <label for="clientId">your app's OAuth 2.0 client ID</label>:<input type="text" id="clientId"><button class="btn btn-default" id="clientIdSave">Generate Link</button></li>
      <li>Click this link generated from your app's client ID: <a id="authLink" href="#">(no client ID provided yet)</a></li>
      <li>Accept the requested permissions and <strong>keep this page open</strong>--it will be needed for the next step...</li>
      <li>The URL on this page should be something like <code>http://localhost/?code=[authorization code]&state=[state]#_=_</code>.<br>Enter <label for="authCode">the authorization code</label>: <input type="text" id="authCode"><button class="btn btn-default" id="authCodeSave">Save</button></li>
      <li>More instructions to come...</li>
    </ol>

    <script src="../../core/lib/interface.js"></script>
    <script>
      var pkceVerifier = '';
      var pkceChallenge = '';
      var state = '';
      
      var authLinkEl = document.getElementById('authLink');

      function generateAuthLink(clientId) {
        return 'https://www.fitbit.com/oauth2/authorize?response_type=code&client_id=' + clientId + '&scope=activity+cardio_fitness+electrocardiogram+heartrate+irregular_rhythm_notifications+location+nutrition+oxygen_saturation+profile+respiratory_rate+settings+sleep+social+temperature+weight&code_challenge=' + pkceChallenge + '&code_challenge_method=S256&state=' + state + '&redirect_uri=http%3A%2F%2Flocalhost';
      }

      function checkInput() {
        if (document.getElementById('clientId').value === '') {
          document.getElementById('clientIdSave').disabled = true;
        }
        else {
          document.getElementById('clientIdSave').disabled = false;
        }

        if (document.getElementById('authCode').value === '') {
          document.getElementById('authCodeSave').disabled = true;
        }
        else {
          document.getElementById('authCodeSave').disabled = false;
        }
      }
      checkInput();

      var settings = {};

      function onInit(){
        console.log('Loading settings from BangleJs...');
        try {
          Util.readStorageJSON('syncfitbit.json', data => {
            if (data) {
              settings = data;
              console.log('Got settings', settings);
              
              document.getElementById('clientId').value = settings.clientid;
              console.log('Loaded client ID from BangleJs.');

              document.getElementById('authCode').value = settings.authcode;
              console.log('Loaded auth code from BangleJs.');
              
              checkInput();
            }
          });
        }
        catch(ex) {
            console.log('(Warning) Could not load settings from BangleJs.');
            console.log(ex);
        }
      }
      
      document.getElementById('clientIdSave').addEventListener('click', function() {
        var clientId = document.getElementById('clientId').value;
        var authLink = generateAuthLink(clientId);
        authLinkEl.href = authLink;
        authLinkEl.text = authLink;
        try {
          settings.clientid = clientId;
          Util.showModal('Saving...');
          Util.writeStorage('syncfitbit.json', JSON.stringify(settings), ()=>{
            Util.hideModal();
          });
          console.log('Sent settings!');
        }
        catch(ex) {
          console.log('(Warning) Could not write client ID to BangleJs.');
          console.log(ex);
        }
      });

      document.getElementById('authCodeSave').addEventListener('click', function() {
          try {
            settings.authcode = document.getElementById('authCode').value;
            Util.showModal("Saving...");
            Util.writeStorage('syncfitbit.json', JSON.stringify(settings), ()=>{
              Util.hideModal();
            });
            console.log('Sent settings!');
          }
          catch(ex) {
            console.log('(Warning) Could not write auth code to BangleJs.');
            console.log(ex);
          }
      });
    </script>
  </body>
</html>
