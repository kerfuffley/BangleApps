<html>

<head>
    <link rel="stylesheet" href="../../css/spectre.min.css">
</head>

<body>
    <h1>Sync to Fitbit Setup</h1>
    <h3>1. Get a Fitbit account if you don't have one already</h3>
    <p>Do this at <a href="https://accounts.fitbit.com/signup">accounts.fitbit.com/signup</a>. After signing up you'll also need to verify your email.</p>
    <h3>2. Register an app</h3>
    <p>You need to do this in order to use Fitbit's API. Follow <a href="https://dev.fitbit.com/build/reference/web-api/developer-guide/getting-started/#Registering-an-Application">these instructions</a> to register an app. <strong>Have your app's settings match the following:</strong>:</p>
    <ul>
        <li>OAuth 2.0 Application Type: Personal</li>
        <li>Redirect URL: <code>http://localhost</code></li>
        <li>Default Access Type: Read & Write</li>
    </ul>
    <p>The other settings don't matter as far as this Bangle.js app is concerned, so change them to whatever you want.</p>
    <h3>3. Allow access and get other app info</h3>
    <ol>
        <li data-step="1">Hold on, a PKCE challenge is still being generated, which is needed for the next step...</li>
        <li data-step="2" class="d-none">
            Enter <label for="clientId">your app's OAuth 2.0 client ID</label>:<br>
            <div class="input-group"><input type="text" id="clientId" class="form-input"><button type="button" class="btn btn-default input-group-btn" id="clientIdSave">Continue</button></div>
        </li>
        <li data-step="3" class="d-none">Enter your app's client ID above for more instructions...</li>
        <li data-step="4" class="d-none">Click this link generated from your app's client ID: <a id="authLink" class="text-break" href="#" target="_blank">(no client ID provided yet)</a></li>
        <li data-step="5" class="d-none">Accept the requested permissions and <strong>keep this page open</strong>--it will be needed for the next step...</li>
        <li data-step="6" class="d-none">The URL on this page should be something like <code>http://localhost/?code=[authorization code]&state=[state]#_=_</code>.<br>Enter <label for="authCode">the authorization code</label>: <div class="input-group"><input type="text" id="authCode" class="form-input"><button type="button" class="btn btn-default input-group-btn" id="authCodeSave">Save</button></div>
        </li>
        <li data-step="7" class="d-none">More instructions to come...</li>
    </ol>

    <script src="../../core/lib/interface.js"></script>
    <script>
        function generateRandomString(length) {
            var array = new Uint32Array(length);
            window.crypto.getRandomValues(array);
            return Array.from(array, dec => ('0' + dec.toString(16)).substr(-2)).join('');
        }

        // Calculate the SHA256 hash of the input text. 
        // Returns a promise that resolves to an ArrayBuffer
        // Source: https://gist.github.com/ahmetgeymen/a9dcd656a1527f6c73d9c712ea2d9d7e
        function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            return window.crypto.subtle.digest('SHA-256', data);
        }

        // Base64-urlencodes the input string
        // Source: https://gist.github.com/ahmetgeymen/a9dcd656a1527f6c73d9c712ea2d9d7e
        function base64urlencode(str) {
            // Convert the ArrayBuffer to string using Uint8 array to conver to what btoa accepts.
            // btoa accepts chars only within ascii 0-255 and base64 encodes them.
            // Then convert the base64 encoded to base64url encoded
            //   (replace + with -, replace / with _, trim trailing =)
            return btoa(String.fromCharCode.apply(null, new Uint8Array(str)))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        // Return the base64-urlencoded sha256 hash for the PKCE challenge
        // Source: https://gist.github.com/ahmetgeymen/a9dcd656a1527f6c73d9c712ea2d9d7e
        async function pkceChallengeFromVerifier(v) {
            var hashed = await sha256(v);
            return base64urlencode(hashed);
        }

        // Create a new PKCE code_verifier (the plaintext random secret)
        var pkceVerifier = generateRandomString(64);

        // Create a random "state" value
        var state = generateRandomString(16);

        console.log('PKCE verifier: ', pkceVerifier);
        console.log('State: ', state);

        // Hash and base64-urlencode the secret to use as the challenge
        var pkceChallenge = '';

        function showCorrectSteps() {
            document.querySelectorAll('[data-step]').forEach((el, i) => {
                var stepAsNumber = parseInt(el.dataset.step);

                if (pkceChallenge != '') {
                    if (stepAsNumber == 1) {
                        el.classList.add('d-none');
                    }
                    else if (stepAsNumber == 2) {
                        el.classList.remove('d-none');
                    }
                    else if (stepAsNumber == 3) {
                        if (document.getElementById('clientId').value != '') {
                            el.classList.add('d-none');
                            console.log('step 3 hidden cuz client id not empty');
                        }
                        else {
                            el.classList.remove('d-none');
                            console.log('step 3 shown cuz client id empty');
                        }
                    }
                    else if (stepAsNumber >= 4) {
                        if (document.getElementById('clientId').value != '') {
                            el.classList.remove('d-none');
                            console.log('step ' + stepAsNumber + ' shown cuz client id not empty');
                        }
                        else {
                            el.classList.add('d-none');
                            console.log('step ' + stepAsNumber + ' hidden cuz client id empty');
                        }
                    }
                }
            });
        }

        function updateAuthLink() {
            var clientId = document.getElementById('clientId').value;
            if (clientId != '' && pkceChallenge != '') {
                var authLinkEl = document.getElementById('authLink');
                var authLink = 'https://www.fitbit.com/oauth2/authorize?response_type=code&client_id=' + clientId + '&scope=activity+cardio_fitness+electrocardiogram+heartrate+irregular_rhythm_notifications+location+nutrition+oxygen_saturation+profile+respiratory_rate+settings+sleep+social+temperature+weight&code_challenge=' + pkceChallenge + '&code_challenge_method=S256&state=' + state + '&redirect_uri=http%3A%2F%2Flocalhost';
                authLinkEl.href = authLink;
                authLinkEl.text = authLink;
            }
        }

        pkceChallengeFromVerifier(pkceVerifier).then(function (result) {
            console.log('PKCE challenge: ', result);
            pkceChallenge = result;
            updateAuthLink();
            showCorrectSteps();
        });

        var settingsFile = 'syncfitbit.json';
        var settings = {};

        function onInit() {
            console.log('Loading settings from BangleJs...');
            try {
                Util.readStorageJSON(settingsFile, data => {
                    console.log(data);
                    if (data) {
                        settings = data;
                        console.log('Got settings', settings);

                        if ('clientid' in settings) {
                            document.getElementById('clientId').value = settings.clientid;
                            console.log('Loaded client ID from BangleJs.');
                        }

                        if ('authcode' in settings) {
                            document.getElementById('authCode').value = settings.authcode;
                            console.log('Loaded auth code from BangleJs.');
                        }

                        updateAuthLink();
                        showCorrectSteps();
                    }
                    else {
                        console.log('No settings found');
                    }
                });
            }
            catch (ex) {
                console.log('(Warning) Could not load settings from BangleJs.');
                console.log(ex);
            }
        }

        document.getElementById('clientIdSave').addEventListener('click', function () {
            updateAuthLink();
            showCorrectSteps();

            try {
                settings.clientid = document.getElementById('clientId').value;
                Util.showModal('Saving...');
                Util.writeStorage(settingsFile, JSON.stringify(settings), () => {
                    Util.hideModal();
                });
                console.log('Client ID updated in settings!');
            }
            catch (ex) {
                console.log('(Warning) Could not write client ID to settings.');
                console.log(ex);
            }
        });

        document.getElementById('authCodeSave').addEventListener('click', function () {
            try {
                settings.authcode = document.getElementById('authCode').value;
                Util.showModal("Saving...");
                Util.writeStorage(settingsFile, JSON.stringify(settings), () => {
                    Util.hideModal();
                });
                console.log('Auth code updated in settings!');
            }
            catch (ex) {
                console.log('(Warning) Could not write auth code to settings.');
                console.log(ex);
            }
        });
    </script>
</body>

</html>